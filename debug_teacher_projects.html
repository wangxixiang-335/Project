<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆé¡¹ç›®åˆ—è¡¨è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .success { color: #10b981; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; border: none; border-radius: 5px; background: #667eea; color: white; font-weight: 500; }
        button:hover { background: #5a67d8; }
        #console { background: #1f2937; color: #f3f4f6; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .project-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .project-title { font-weight: bold; color: #2d3748; margin-bottom: 8px; }
        .project-meta { color: #718096; font-size: 14px; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; margin-left: 8px; }
        .status-0 { background: #fed7d7; color: #c53030; } /* è‰ç¨¿ */
        .status-1 { background: #feebc8; color: #dd6b20; } /* å®¡æ ¸ä¸­ */
        .status-2 { background: #c6f6d5; color: #38a169; } /* å·²é€šè¿‡ */
        .status-3 { background: #e2e8f0; color: #4a5568; } /* å·²æ‰“å› */
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ•™å¸ˆé¡¹ç›®åˆ—è¡¨è°ƒè¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h3>ğŸ” ç¯å¢ƒæ£€æŸ¥</h3>
            <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
            <button onclick="checkAuth()">æ£€æŸ¥è®¤è¯</button>
            <button onclick="checkContainers()">æ£€æŸ¥å®¹å™¨</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª APIæµ‹è¯•</h3>
            <button onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
            <button onclick="testTeacherProjects()">æµ‹è¯•æ•™å¸ˆé¡¹ç›®API</button>
            <button onclick="testMockData()">æµ‹è¯•æ¨¡æ‹Ÿæ•°æ®</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š æ•°æ®éªŒè¯</h3>
            <button onclick="validateProjectData()">éªŒè¯é¡¹ç›®æ•°æ®</button>
            <button onclick="checkRenderLogic()">æ£€æŸ¥æ¸²æŸ“é€»è¾‘</button>
            <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ é—®é¢˜è¯Šæ–­</h3>
            <div id="diagnostic-info">
                <p><strong>å¸¸è§é—®é¢˜ï¼š</strong></p>
                <ul>
                    <li>å®¹å™¨IDä¸åŒ¹é…ï¼šç¡®ä¿ä½¿ç”¨ projectManageList è€Œä¸æ˜¯ projectList</li>
                    <li>è®¤è¯å¤±è´¥ï¼šæ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ</li>
                    <li>APIè·¯å¾„é”™è¯¯ï¼šä½¿ç”¨ /teacher/my-projects è€Œä¸æ˜¯ /projects/teacher</li>
                    <li>æ•°æ®æ ¼å¼ä¸åŒ¹é…ï¼šæ£€æŸ¥åç«¯è¿”å›çš„æ•°æ®ç»“æ„</li>
                </ul>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ æ§åˆ¶å°è¾“å‡º</h3>
            <div id="console">ç­‰å¾…è°ƒè¯•å¼€å§‹...</div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#f3f4f6';
            console.innerHTML += `[${timestamp}] <span style="color: ${color}">${message}</span>\n`;
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = 'æ§åˆ¶å°å·²æ¸…ç©º\n';
        }

        function checkEnvironment() {
            log('=== ç¯å¢ƒæ£€æŸ¥ ===');
            
            // æ£€æŸ¥teacherSystem
            if (typeof window.teacherSystem !== 'undefined') {
                log('âœ… teacherSystemå¯¹è±¡å­˜åœ¨', 'success');
                log(`å½“å‰é¡µé¢: ${teacherSystem.currentPage || 'æœªçŸ¥'}`);
                log(`å½“å‰ç”¨æˆ·: ${teacherSystem.user ? teacherSystem.user.username : 'æœªç™»å½•'}`);
            } else {
                log('âš ï¸  teacherSystemå¯¹è±¡ä¸å­˜åœ¨', 'warning');
                log('â„¹ï¸  è¯·åœ¨æ•™å¸ˆç³»ç»Ÿé¡µé¢(teacher.html)ä¸­è¿è¡Œæ­¤æµ‹è¯•', 'info');
            }
            
            // æ£€æŸ¥å‡½æ•°
            log(`loadProjectså‡½æ•°: ${typeof window.teacherSystem?.loadProjects === 'function' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            log(`renderProjectså‡½æ•°: ${typeof window.teacherSystem?.renderProjects === 'function' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            
            // æ£€æŸ¥å®¹å™¨
            const manageContainer = document.getElementById('projectManageList');
            const oldContainer = document.getElementById('projectList');
            log(`æˆæœç®¡ç†å®¹å™¨(projectManageList): ${manageContainer ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            log(`æ—§å®¹å™¨(projectList): ${oldContainer ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
        }

        function checkAuth() {
            log('=== è®¤è¯æ£€æŸ¥ ===');
            
            const token = localStorage.getItem('teacherToken') || sessionStorage.getItem('teacherToken');
            log(`Tokenå­˜åœ¨: ${token ? 'æ˜¯' : 'å¦'}`);
            
            if (token) {
                log(`Tokené•¿åº¦: ${token.length} å­—ç¬¦`);
                log(`Tokenå‰ç¼€: ${token.substring(0, 20)}...`);
            } else {
                log('âŒ æ²¡æœ‰tokenï¼Œæ— æ³•è®¿é—®å—ä¿æŠ¤çš„API', 'error');
            }
        }

        function checkContainers() {
            log('=== å®¹å™¨æ£€æŸ¥ ===');
            
            // æ£€æŸ¥æˆæœç®¡ç†é¡µé¢å®¹å™¨
            const manageContainer = document.getElementById('projectManageList');
            if (manageContainer) {
                log('âœ… æ‰¾åˆ°æˆæœç®¡ç†å®¹å™¨: projectManageList', 'success');
                log(`å®¹å™¨å†…å®¹: ${manageContainer.innerHTML.substring(0, 100)}...`);
            } else {
                log('âŒ æœªæ‰¾åˆ°æˆæœç®¡ç†å®¹å™¨', 'error');
            }
            
            // æ£€æŸ¥å…¶ä»–å¯èƒ½çš„å®¹å™¨
            const containers = ['projectList', 'projectManageList', 'manageList'];
            containers.forEach(id => {
                const element = document.getElementById(id);
                log(`å®¹å™¨ ${id}: ${element ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            });
        }

        async function testApiConnection() {
            log('=== APIè¿æ¥æµ‹è¯• ===');
            
            const token = localStorage.getItem('teacherToken') || sessionStorage.getItem('teacherToken');
            if (!token) {
                log('âŒ æ²¡æœ‰tokenï¼Œè·³è¿‡APIæµ‹è¯•', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/teacher/my-projects', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`APIå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… APIè¿æ¥æˆåŠŸ', 'success');
                    log(`è¿”å›æ•°æ®: ${JSON.stringify(data, null, 2).substring(0, 200)}...`);
                } else {
                    const errorText = await response.text();
                    log(`âŒ APIè¯·æ±‚å¤±è´¥: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`âŒ APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testTeacherProjects() {
            log('=== æ•™å¸ˆé¡¹ç›®APIæµ‹è¯• ===');
            
            if (typeof window.teacherSystem === 'undefined') {
                log('âŒ teacherSystemæœªå®šä¹‰', 'error');
                return;
            }
            
            try {
                log('è°ƒç”¨ teacherSystem.loadProjects()...');
                await teacherSystem.loadProjects();
                log('âœ… loadProjects è°ƒç”¨å®Œæˆ', 'success');
                
                if (teacherSystem.projects && teacherSystem.projects.length > 0) {
                    log(`âœ… è·å–åˆ° ${teacherSystem.projects.length} ä¸ªé¡¹ç›®`, 'success');
                    displayProjects(teacherSystem.projects);
                } else {
                    log('âš ï¸  é¡¹ç›®åˆ—è¡¨ä¸ºç©º', 'warning');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
        }

        function testMockData() {
            log('=== æ¨¡æ‹Ÿæ•°æ®æµ‹è¯• ===');
            
            if (typeof window.teacherSystem === 'undefined') {
                log('âŒ teacherSystemæœªå®šä¹‰', 'error');
                return;
            }
            
            try {
                teacherSystem.loadMockProjects();
                log('âœ… æ¨¡æ‹Ÿæ•°æ®åŠ è½½å®Œæˆ', 'success');
                
                if (teacherSystem.projects && teacherSystem.projects.length > 0) {
                    log(`âœ… è·å–åˆ° ${teacherSystem.projects.length} ä¸ªæ¨¡æ‹Ÿé¡¹ç›®`, 'success');
                    displayProjects(teacherSystem.projects);
                }
            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function displayProjects(projects) {
            if (!projects || projects.length === 0) {
                log('âš ï¸  æ²¡æœ‰é¡¹ç›®å¯æ˜¾ç¤º', 'warning');
                return;
            }
            
            log('ğŸ“Š é¡¹ç›®åˆ—è¡¨:');
            projects.forEach((project, index) => {
                const statusClass = `status-${project.status || 0}`;
                log(`  ${index + 1}. ${project.title} (${project.type || 'æœªçŸ¥ç±»å‹'}) [çŠ¶æ€: ${project.status || 0}]`);
            });
        }

        function validateProjectData() {
            log('=== é¡¹ç›®æ•°æ®éªŒè¯ ===');
            
            if (!window.teacherSystem || !teacherSystem.projects) {
                log('âš ï¸  æ²¡æœ‰é¡¹ç›®æ•°æ®å¯éªŒè¯', 'warning');
                return;
            }
            
            const projects = teacherSystem.projects;
            log(`éªŒè¯ ${projects.length} ä¸ªé¡¹ç›®æ•°æ®...`);
            
            projects.forEach((project, index) => {
                const errors = [];
                if (!project.id) errors.push('ç¼ºå°‘ID');
                if (!project.title) errors.push('ç¼ºå°‘æ ‡é¢˜');
                if (project.status === undefined) errors.push('ç¼ºå°‘çŠ¶æ€');
                
                if (errors.length > 0) {
                    log(`âŒ é¡¹ç›® ${index + 1} æ•°æ®é”™è¯¯: ${errors.join(', ')}`, 'error');
                } else {
                    log(`âœ… é¡¹ç›® ${index + 1} æ•°æ®å®Œæ•´: ${project.title}`);
                }
            });
        }

        function checkRenderLogic() {
            log('=== æ¸²æŸ“é€»è¾‘æ£€æŸ¥ ===');
            
            if (typeof window.teacherSystem === 'undefined') {
                log('âŒ teacherSystemæœªå®šä¹‰', 'error');
                return;
            }
            
            const container = document.getElementById('projectManageList');
            if (!container) {
                log('âŒ æ‰¾ä¸åˆ°æ¸²æŸ“å®¹å™¨ projectManageList', 'error');
                return;
            }
            
            log('âœ… æ¸²æŸ“å®¹å™¨å­˜åœ¨', 'success');
            log(`å½“å‰å®¹å™¨å†…å®¹: ${container.innerHTML.substring(0, 200)}...`);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é¡¹ç›®æ•°æ®
            if (teacherSystem.projects && teacherSystem.projects.length > 0) {
                log(`âœ… æœ‰ ${teacherSystem.projects.length} ä¸ªé¡¹ç›®ç­‰å¾…æ¸²æŸ“`, 'success');
            } else {
                log('âš ï¸  æ²¡æœ‰é¡¹ç›®æ•°æ®', 'warning');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ æ•™å¸ˆé¡¹ç›®åˆ—è¡¨è°ƒè¯•å·¥å…·åŠ è½½å®Œæˆ');
            log('â„¹ï¸  è¯·åœ¨æ•™å¸ˆç³»ç»Ÿé¡µé¢(teacher.html)ä¸­æµ‹è¯•å®é™…åŠŸèƒ½');
        });
    </script>
</body>
</html>