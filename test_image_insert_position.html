<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ’å…¥ä½ç½®æµ‹è¯• - å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .instructions {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        .instructions h4 {
            margin-top: 0;
            color: #1976d2;
        }
        .instructions ol {
            margin-bottom: 0;
        }
        .instructions li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å›¾ç‰‡æ’å…¥ä½ç½®æµ‹è¯•</h1>
        <p>æµ‹è¯•å›¾ç‰‡æ˜¯å¦æ­£ç¡®æ’å…¥åˆ°å…‰æ ‡ä½ç½®</p>

        <div class="instructions">
            <h4>ğŸ“‹ æµ‹è¯•æ­¥éª¤ï¼š</h4>
            <ol>
                <li>åœ¨ä¸‹é¢çš„ç¼–è¾‘å™¨ä¸­è¾“å…¥ä¸€äº›æ–‡å­—</li>
                <li>å°†å…‰æ ‡æ”¾åœ¨æ–‡å­—ä¸­é—´ï¼ˆä¸è¦é€‰ä¸­ä»»ä½•æ–‡å­—ï¼‰</li>
                <li>ç‚¹å‡»"æ’å…¥æµ‹è¯•å›¾ç‰‡"æŒ‰é’®</li>
                <li>è§‚å¯Ÿå›¾ç‰‡æ˜¯å¦æ’å…¥åˆ°å…‰æ ‡ä½ç½®</li>
                <li>é‡å¤æµ‹è¯•ï¼Œå°†å…‰æ ‡æ”¾åœ¨ä¸åŒä½ç½®</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ“ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</h3>
            <div id="editorStatus">
                <div class="status info">æ­£åœ¨åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨...</div>
            </div>
            <div id="richEditorContainer" style="margin-top: 20px;"></div>
            
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="insertTestImage()">ğŸ–¼ï¸ æ’å…¥æµ‹è¯•å›¾ç‰‡</button>
                <button class="btn btn-success" onclick="insertSampleText()">ğŸ“ æ’å…¥ç¤ºä¾‹æ–‡å­—</button>
                <button class="btn btn-info" onclick="getContent()">ğŸ“‹ è·å–å†…å®¹</button>
                <button class="btn btn-primary" onclick="clearEditor()">ğŸ§¹ æ¸…ç©ºç¼–è¾‘å™¨</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å†…å®¹åˆ†æ</h3>
            <div id="contentAnalysis">
                <div class="status info">ç­‰å¾…å†…å®¹åˆ†æ...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debugInfo" class="debug-panel">
// è°ƒè¯•ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
            </div>
        </div>
    </div>

    <script>
        let richEditor = null;
        const API_BASE = '/api';

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            debugInfo.textContent += logEntry;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }

        // åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        async function loadRichEditor() {
            try {
                log('å¼€å§‹åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨...');
                showStatus('editorStatus', 'æ­£åœ¨åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨...', 'info');
                
                // åŠ¨æ€åŠ è½½è„šæœ¬
                if (typeof window.RichTextEditor === 'undefined') {
                    log('RichTextEditoræœªå®šä¹‰ï¼ŒåŠ¨æ€åŠ è½½è„šæœ¬...');
                    
                    const script = document.createElement('script');
                    script.src = '/rich-editor.js';
                    script.async = true;
                    
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    
                    log('âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è„šæœ¬åŠ è½½æˆåŠŸ');
                }
                
                // åˆå§‹åŒ–ç¼–è¾‘å™¨
                if (typeof window.RichTextEditor !== 'undefined') {
                    richEditor = new window.RichTextEditor('richEditorContainer', {
                        placeholder: 'è¯·åœ¨è¿™é‡Œè¾“å…¥æ–‡å­—ï¼Œç„¶åå°†å…‰æ ‡æ”¾åœ¨æ–‡å­—ä¸­é—´ï¼Œç‚¹å‡»ä¸Šæ–¹çš„"æ’å…¥æµ‹è¯•å›¾ç‰‡"æŒ‰é’®æµ‹è¯•å›¾ç‰‡æ’å…¥ä½ç½®...',
                        maxImages: 10,
                        uploadEndpoint: `${API_BASE}/upload/image`,
                        onImageUpload: (data) => {
                            log(`âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ${data.url}`);
                            showStatus('editorStatus', 'âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                            analyzeContent();
                        },
                        onContentChange: (content) => {
                            log('å†…å®¹å·²æ›´æ–°');
                            analyzeContent();
                        }
                    });
                    
                    // æ·»åŠ ä¸€äº›åˆå§‹æ–‡å­—ç”¨äºæµ‹è¯•
                    setTimeout(() => {
                        insertSampleText();
                    }, 500);
                    
                    log('âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆå§‹åŒ–æˆåŠŸ');
                    showStatus('editorStatus', 'âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å·²å°±ç»ªï¼Œè¯·åœ¨æ–‡å­—ä¸­é—´ç‚¹å‡»æ’å…¥å›¾ç‰‡æµ‹è¯•', 'success');
                } else {
                    throw new Error('å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠ è½½å¤±è´¥');
                }
                
            } catch (error) {
                log(`âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                showStatus('editorStatus', `âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ’å…¥æµ‹è¯•å›¾ç‰‡
        function insertTestImage() {
            if (!richEditor) {
                log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            // ä½¿ç”¨åœ¨çº¿å ä½å›¾ç‰‡ä½œä¸ºæµ‹è¯•
            const testImageUrl = 'https://via.placeholder.com/400x300/FF6B6B/FFFFFF?text=æµ‹è¯•å›¾ç‰‡';
            
            log('æ­£åœ¨æ’å…¥æµ‹è¯•å›¾ç‰‡...');
            log(`å›¾ç‰‡URL: ${testImageUrl}`);
            
            // è®°å½•å½“å‰å…‰æ ‡ä½ç½®ä¿¡æ¯
            const selection = window.getSelection();
            if (selection && selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;
                const containerText = container.textContent || '';
                const cursorPosition = range.startOffset;
                
                log(`å…‰æ ‡ä½ç½®ä¿¡æ¯:`);
                log(`- å®¹å™¨ç±»å‹: ${container.nodeType === Node.TEXT_NODE ? 'æ–‡æœ¬èŠ‚ç‚¹' : 'å…ƒç´ èŠ‚ç‚¹'}`);
                log(`- å®¹å™¨å†…å®¹: "${containerText.substring(0, 50)}${containerText.length > 50 ? '...' : ''}"`);
                log(`- å…‰æ ‡ä½ç½®: ${cursorPosition} / ${containerText.length}`);
                log(`- æ˜¯å¦åœ¨ç¼–è¾‘å™¨å†…: ${richEditor.editor.contains(container)}`);
            }
            
            // æ’å…¥å›¾ç‰‡
            richEditor.insertImageToEditor(testImageUrl, 'æµ‹è¯•å›¾ç‰‡');
            
            log('âœ… æµ‹è¯•å›¾ç‰‡æ’å…¥å®Œæˆ');
            showStatus('editorStatus', 'âœ… æµ‹è¯•å›¾ç‰‡å·²æ’å…¥ï¼Œè¯·æ£€æŸ¥ä½ç½®æ˜¯å¦æ­£ç¡®', 'success');
        }

        // æ’å…¥ç¤ºä¾‹æ–‡å­—
        function insertSampleText() {
            if (!richEditor) {
                log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const sampleText = `
                <h3>ğŸ¯ æµ‹è¯•æ ‡é¢˜</h3>
                <p>è¿™æ˜¯ç¬¬ä¸€è¡Œæ–‡å­—ï¼Œè¯·å°†å…‰æ ‡æ”¾åœ¨è¿™é‡Œ â†’ å…‰æ ‡ä½ç½® â† ç„¶åç‚¹å‡»æ’å…¥å›¾ç‰‡æŒ‰é’®ã€‚</p>
                <p>è¿™æ˜¯ç¬¬äºŒè¡Œæ–‡å­—ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œ â†’ å¦ä¸€ä¸ªä½ç½® â† æµ‹è¯•å›¾ç‰‡æ’å…¥ã€‚</p>
                <p>è¿™æ˜¯ç¬¬ä¸‰è¡Œæ–‡å­—ï¼Œ<strong>åŠ ç²—æ–‡å­—</strong>å’Œ<em>æ–œä½“æ–‡å­—</em>ä¹‹é—´ä¹Ÿå¯ä»¥æµ‹è¯•ã€‚</p>
                <p>æœ€åä¸€è¡Œæ–‡å­—ï¼Œåœ¨ENDä¹‹å‰æ’å…¥å›¾ç‰‡åº”è¯¥åœ¨è¿™é‡Œ â†’ END</p>
            `;
            
            richEditor.setContent(sampleText);
            log('âœ… ç¤ºä¾‹æ–‡å­—å·²æ’å…¥');
            
            // å°†å…‰æ ‡æ”¾åœ¨æŒ‡å®šä½ç½®
            setTimeout(() => {
                const editor = richEditor.editor;
                const targetText = 'å…‰æ ‡ä½ç½®';
                const walker = document.createTreeWalker(
                    editor,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let textNode = null;
                let node;
                
                while (node = walker.nextNode()) {
                    const index = node.textContent.indexOf(targetText);
                    if (index !== -1) {
                        textNode = node;
                        break;
                    }
                }
                
                if (textNode) {
                    const range = document.createRange();
                    const index = textNode.textContent.indexOf(targetText);
                    range.setStart(textNode, index + targetText.length);
                    range.collapse(true);
                    
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    log(`âœ… å…‰æ ‡å·²å®šä½åˆ°"${targetText}"åé¢`);
                    editor.focus();
                }
            }, 100);
        }

        // åˆ†æå†…å®¹
        function analyzeContent() {
            if (!richEditor) return;
            
            const content = richEditor.getContent();
            const textContent = richEditor.getTextContent();
            const images = richEditor.getImages();
            
            // åˆ†æå›¾ç‰‡ä½ç½®
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            const imgElements = tempDiv.querySelectorAll('img');
            let positionAnalysis = '';
            
            imgElements.forEach((img, index) => {
                const prevText = img.previousSibling ? img.previousSibling.textContent || '' : '';
                const nextText = img.nextSibling ? img.nextSibling.textContent || '' : '';
                
                positionAnalysis += `å›¾ç‰‡${index + 1}: "${prevText.substring(-20)}" â†’ [å›¾ç‰‡] â†’ "${nextText.substring(0, 20)}"\n`;
            });
            
            const analysisHtml = `
                <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ddd;">
                    <h4>ğŸ“Š å†…å®¹åˆ†æç»“æœ</h4>
                    <p><strong>HTMLé•¿åº¦:</strong> ${content.length} å­—ç¬¦</p>
                    <p><strong>çº¯æ–‡æœ¬é•¿åº¦:</strong> ${textContent.length} å­—ç¬¦</p>
                    <p><strong>å›¾ç‰‡æ•°é‡:</strong> ${images.length} å¼ </p>
                    ${images.length > 0 ? `
                        <p><strong>å›¾ç‰‡è¯¦æƒ…:</strong></p>
                        <ul>
                            ${images.map((img, index) => `<li>å›¾ç‰‡${index + 1}: <a href="${img.url}" target="_blank">${img.url}</a></li>`).join('')}
                        </ul>
                        <p><strong>å›¾ç‰‡ä½ç½®åˆ†æ:</strong></p>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px;">${positionAnalysis}</pre>
                    ` : '<p><em>æš‚æ— å›¾ç‰‡</em></p>'}
                </div>
            `;
            
            document.getElementById('contentAnalysis').innerHTML = analysisHtml;
            log('å†…å®¹åˆ†æå®Œæˆ');
        }

        // è·å–å†…å®¹
        function getContent() {
            if (!richEditor) {
                log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const content = richEditor.getContent();
            const textContent = richEditor.getTextContent();
            const images = richEditor.getImages();
            
            log('è·å–å†…å®¹æˆåŠŸ');
            log(`HTMLé•¿åº¦: ${content.length} å­—ç¬¦`);
            log(`çº¯æ–‡æœ¬é•¿åº¦: ${textContent.length} å­—ç¬¦`);
            log(`å›¾ç‰‡æ•°é‡: ${images.length} å¼ `);
            
            analyzeContent();
        }

        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearEditor() {
            if (!richEditor) {
                log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            richEditor.clear();
            log('âœ… ç¼–è¾‘å™¨å·²æ¸…ç©º');
            showStatus('editorStatus', 'âœ… ç¼–è¾‘å™¨å·²æ¸…ç©º', 'success');
            document.getElementById('contentAnalysis').innerHTML = '<div class="status info">å†…å®¹å·²æ¸…ç©º</div>';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // å»¶è¿ŸåŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            setTimeout(() => {
                loadRichEditor();
            }, 500);
        });
    </script>
</body>
</html>