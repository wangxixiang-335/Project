<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆæˆæœåº“ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .step {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>ğŸ“ æ•™å¸ˆæˆæœåº“ä¿®å¤éªŒè¯</h1>
    
    <!-- ä¿®å¤æ­¥éª¤ -->
    <div class="container">
        <h2>ğŸ“‹ ä¿®å¤çŠ¶æ€æ£€æŸ¥</h2>
        
        <div class="step" id="step1">
            <h3>æ­¥éª¤ 1: æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</h3>
            <button onclick="checkServers()">æ£€æŸ¥æœåŠ¡å™¨</button>
            <div id="serverStatus" class="result">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</div>
        </div>
        
        <div class="step" id="step2">
            <h3>æ­¥éª¤ 2: è®¾ç½®æ•™å¸ˆToken</h3>
            <button onclick="setTeacherToken()">è®¾ç½®æ•™å¸ˆToken</button>
            <div id="tokenStatus" class="result">ç‚¹å‡»æŒ‰é’®è®¾ç½®Token...</div>
        </div>
        
        <div class="step" id="step3">
            <h3>æ­¥éª¤ 3: æµ‹è¯•APIè¿æ¥</h3>
            <button onclick="testAPI()">æµ‹è¯•API</button>
            <div id="apiStatus" class="result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•API...</div>
        </div>
        
        <div class="step" id="step4">
            <h3>æ­¥éª¤ 4: éªŒè¯æ•°æ®è®¿é—®</h3>
            <button onclick="verifyData()">éªŒè¯æ•°æ®</button>
            <div id="dataStatus" class="result">ç‚¹å‡»æŒ‰é’®éªŒè¯æ•°æ®...</div>
        </div>
    </div>
    
    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="container">
        <h2>ğŸš€ å¿«é€Ÿæ“ä½œ</h2>
        <button onclick="autoFix()">ä¸€é”®ä¿®å¤</button>
        <button onclick="openFrontend()">æ‰“å¼€å‰ç«¯</button>
        <button onclick="openTestPage()">æ‰“å¼€æµ‹è¯•é¡µé¢</button>
        <div id="quickResult" class="result">ä½¿ç”¨å¿«é€Ÿæ“ä½œæ¥è‡ªåŠ¨ä¿®å¤å’Œæµ‹è¯•...</div>
    </div>
    
    <!-- æ•°æ®å±•ç¤º -->
    <div class="container">
        <h2>ğŸ“Š æ•°æ®éªŒè¯ç»“æœ</h2>
        <div id="dataDisplay"></div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:3000/api';
        
        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServers() {
            const statusDiv = document.getElementById('serverStatus');
            statusDiv.textContent = 'ğŸ”„ æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...';
            
            try {
                // æ£€æŸ¥åç«¯
                const backendResponse = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    timeout: 5000
                }).catch(() => ({ ok: false }));
                
                // æ£€æŸ¥å‰ç«¯
                const frontendResponse = await fetch('http://localhost:5176/', {
                    method: 'GET',
                    timeout: 5000
                }).catch(() => ({ ok: false }));
                
                let status = 'âœ… æœåŠ¡å™¨çŠ¶æ€:\n';
                status += backendResponse.ok ? '  âœ… åç«¯æœåŠ¡å™¨ (localhost:3000) - è¿è¡Œä¸­\n' : '  âŒ åç«¯æœåŠ¡å™¨ (localhost:3000) - æœªè¿è¡Œ\n';
                status += frontendResponse.ok ? '  âœ… å‰ç«¯æœåŠ¡å™¨ (localhost:5176) - è¿è¡Œä¸­\n' : '  âŒ å‰ç«¯æœåŠ¡å™¨ (localhost:5176) - æœªè¿è¡Œ\n';
                
                if (backendResponse.ok && frontendResponse.ok) {
                    status += '\nğŸ‰ æ‰€æœ‰æœåŠ¡å™¨éƒ½åœ¨è¿è¡Œï¼';
                    document.getElementById('step1').className = 'step success';
                } else {
                    status += '\nâš ï¸ è¯·å¯åŠ¨ç¼ºå¤±çš„æœåŠ¡å™¨';
                    document.getElementById('step1').className = 'step error';
                }
                
                statusDiv.textContent = status;
                
            } catch (error) {
                statusDiv.textContent = `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
                document.getElementById('step1').className = 'step error';
            }
        }
        
        // è®¾ç½®æ•™å¸ˆToken
        function setTeacherToken() {
            const statusDiv = document.getElementById('tokenStatus');
            
            try {
                // è®¾ç½®å¼€å‘è€…token
                localStorage.setItem('teacherToken', 'dev-teacher-token');
                localStorage.setItem('user', JSON.stringify({
                    id: 'dev-teacher-id',
                    email: 'dev-teacher@example.com',
                    role: 'teacher',
                    username: 'dev-teacher'
                }));
                
                // éªŒè¯tokenè®¾ç½®
                const token = localStorage.getItem('teacherToken');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                let status = 'âœ… Tokenè®¾ç½®æˆåŠŸ:\n';
                status += `  Token: ${token.substring(0, 30)}...\n`;
                status += `  ç”¨æˆ·ID: ${user.id}\n`;
                status += `  ç”¨æˆ·è§’è‰²: ${user.role}\n`;
                status += `  ç”¨æˆ·å: ${user.username}\n\n`;
                status += 'ğŸ¯ ç°åœ¨å¯ä»¥è®¿é—®æ•™å¸ˆåŠŸèƒ½äº†ï¼';
                
                statusDiv.textContent = status;
                document.getElementById('step2').className = 'step success';
                
            } catch (error) {
                statusDiv.textContent = `âŒ Tokenè®¾ç½®å¤±è´¥: ${error.message}`;
                document.getElementById('step2').className = 'step error';
            }
        }
        
        // æµ‹è¯•API
        async function testAPI() {
            const statusDiv = document.getElementById('apiStatus');
            const token = localStorage.getItem('teacherToken');
            
            if (!token) {
                statusDiv.textContent = 'âŒ è¯·å…ˆè®¾ç½®æ•™å¸ˆToken (æ­¥éª¤2)';
                document.getElementById('step3').className = 'step warning';
                return;
            }
            
            statusDiv.textContent = 'ğŸ”„ æµ‹è¯•APIè¿æ¥...';
            
            try {
                const response = await fetch(`${API_BASE}/teacher/student-achievements?page=1&pageSize=5`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                let status = `ğŸ“‹ APIæµ‹è¯•ç»“æœ:\n`;
                status += `  çŠ¶æ€ç : ${response.status}\n`;
                status += `  è¯·æ±‚URL: ${API_BASE}/teacher/student-achievements\n`;
                status += `  Token: ${token.substring(0, 20)}...\n\n`;
                status += `ğŸ“Š å“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}`;
                
                if (response.ok && data.success) {
                    statusDiv.textContent = status;
                    document.getElementById('step3').className = 'step success';
                } else {
                    statusDiv.textContent = status + `\n\nâŒ APIè°ƒç”¨å¤±è´¥`;
                    document.getElementById('step3').className = 'step error';
                }
                
            } catch (error) {
                statusDiv.textContent = `âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`;
                document.getElementById('step3').className = 'step error';
            }
        }
        
        // éªŒè¯æ•°æ®
        async function verifyData() {
            const statusDiv = document.getElementById('dataStatus');
            const displayDiv = document.getElementById('dataDisplay');
            const token = localStorage.getItem('teacherToken');
            
            if (!token) {
                statusDiv.textContent = 'âŒ è¯·å…ˆè®¾ç½®æ•™å¸ˆToken (æ­¥éª¤2)';
                document.getElementById('step4').className = 'step warning';
                return;
            }
            
            statusDiv.textContent = 'ğŸ”„ éªŒè¯æ•°æ®è®¿é—®...';
            
            try {
                const response = await fetch(`${API_BASE}/teacher/student-achievements?page=1&pageSize=10`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const projects = data.data.items || [];
                    
                    let status = `âœ… æ•°æ®éªŒè¯æˆåŠŸ:\n`;
                    status += `  æˆæœæ€»æ•°: ${data.data.pagination?.totalItems || projects.length}\n`;
                    status += `  å½“å‰é¡µé¢: ${projects.length}\n`;
                    status += `  æœ‰æ•°æ®: ${projects.length > 0 ? 'æ˜¯' : 'å¦'}\n`;
                    status += `  æ•°æ®æ¥æº: ${projects.length > 0 ? 'çœŸå®æ•°æ®åº“' : 'æ— æ•°æ®'}`;
                    
                    statusDiv.textContent = status;
                    
                    // æ˜¾ç¤ºæ•°æ®è¯¦æƒ…
                    let display = `<h3>ğŸ“‹ å­¦ç”Ÿæˆæœæ•°æ® (${projects.length}ä¸ª)</h3>`;
                    
                    if (projects.length > 0) {
                        display += '<table border="1" style="width:100%; border-collapse: collapse;">';
                        display += '<tr style="background: #f0f0f0;"><th>æ ‡é¢˜</th><th>å­¦ç”Ÿ</th><th>åˆ†æ•°</th><th>çŠ¶æ€</th><th>æ—¶é—´</th></tr>';
                        
                        projects.forEach(project => {
                            display += '<tr>';
                            display += `<td>${project.title || 'æ— æ ‡é¢˜'}</td>`;
                            display += `<td>${project.student_name || 'æœªçŸ¥'}</td>`;
                            display += `<td>${project.score || 'æœªè¯„åˆ†'}</td>`;
                            display += `<td>${project.status === 2 ? 'å·²é€šè¿‡' : project.status === 1 ? 'å¾…å®¡æ ¸' : 'å…¶ä»–'}</td>`;
                            display += `<td>${new Date(project.created_at).toLocaleString()}</td>`;
                            display += '</tr>';
                        });
                        
                        display += '</table>';
                    } else {
                        display += '<p style="color: #dc3545;">âŒ æ²¡æœ‰æ‰¾åˆ°å­¦ç”Ÿæˆæœæ•°æ®</p>';
                    }
                    
                    displayDiv.innerHTML = display;
                    document.getElementById('step4').className = 'step success';
                    
                } else {
                    statusDiv.textContent = `âŒ æ•°æ®éªŒè¯å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
                    displayDiv.innerHTML = '<p style="color: #dc3545;">æ— æ³•è·å–æ•°æ®</p>';
                    document.getElementById('step4').className = 'step error';
                }
                
            } catch (error) {
                statusDiv.textContent = `âŒ æ•°æ®éªŒè¯å¼‚å¸¸: ${error.message}`;
                displayDiv.innerHTML = `<p style="color: #dc3545;">éªŒè¯å¼‚å¸¸: ${error.message}</p>`;
                document.getElementById('step4').className = 'step error';
            }
        }
        
        // ä¸€é”®ä¿®å¤
        async function autoFix() {
            const resultDiv = document.getElementById('quickResult');
            resultDiv.textContent = 'ğŸ”„ æ‰§è¡Œä¸€é”®ä¿®å¤...';
            
            try {
                // è®¾ç½®token
                localStorage.setItem('teacherToken', 'dev-teacher-token');
                localStorage.setItem('user', JSON.stringify({
                    id: 'dev-teacher-id',
                    email: 'dev-teacher@example.com',
                    role: 'teacher',
                    username: 'dev-teacher'
                }));
                
                // æµ‹è¯•API
                const response = await fetch(`${API_BASE}/teacher/student-achievements?page=1&pageSize=5`, {
                    headers: {
                        'Authorization': 'Bearer dev-teacher-token',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.innerHTML = `ğŸ‰ ä¿®å¤æˆåŠŸï¼\n\nâœ… Tokenå·²è®¾ç½®\nâœ… APIè¿æ¥æ­£å¸¸\nâœ… æ•°æ®è®¿é—®æˆåŠŸ\n\nğŸ“Š æ‰¾åˆ° ${data.data.items?.length || 0} ä¸ªå­¦ç”Ÿæˆæœ\n\nğŸš€ ç°åœ¨å¯ä»¥è®¿é—®å‰ç«¯é¡µé¢äº†ï¼`;
                } else {
                    resultDiv.innerHTML = `âš ï¸ ä¿®å¤éƒ¨åˆ†æˆåŠŸ\n\nâœ… Tokenå·²è®¾ç½®\nâŒ APIä»æœ‰é—®é¢˜\n\né”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}\n\nè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ ä¿®å¤å¤±è´¥\n\né”™è¯¯: ${error.message}\n\nè¯·æ£€æŸ¥:\n1. åç«¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ (localhost:3000)\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`;
            }
        }
        
        // æ‰“å¼€å‰ç«¯
        function openFrontend() {
            window.open('http://localhost:5176/', '_blank');
        }
        
        // æ‰“å¼€æµ‹è¯•é¡µé¢
        function openTestPage() {
            window.open('http://localhost:5176/', '_blank');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            setTimeout(checkServers, 1000);
        };
    </script>
</body>
</html>