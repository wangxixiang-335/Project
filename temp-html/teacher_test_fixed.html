<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆç³»ç»Ÿæµ‹è¯•é¡µé¢ï¼ˆå·²ä¿®å¤ï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.danger {
            background: #dc3545;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-card {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
        }
        .projects-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .projects-table th,
        .projects-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .projects-table th {
            background-color: #f2f2f2;
        }
        .score-excellent { color: #28a745; font-weight: bold; }
        .score-good { color: #17a2b8; font-weight: bold; }
        .score-average { color: #ffc107; font-weight: bold; }
        .score-pass { color: #fd7e14; font-weight: bold; }
        .score-fail { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ“ æ•™å¸ˆç³»ç»Ÿæµ‹è¯•é¡µé¢ï¼ˆå·²ä¿®å¤400é”™è¯¯ï¼‰</h1>

    <!-- çŠ¶æ€å¡ç‰‡ -->
    <div class="container">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalProjects">0</div>
                <div>æ€»æˆæœæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="excellentProjects">0</div>
                <div>ä¼˜ç§€æˆæœ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgScore">0.0</div>
                <div>å¹³å‡åˆ†æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="studentCount">0</div>
                <div>å‚ä¸å­¦ç”Ÿ</div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•å’ŒAPIæµ‹è¯• -->
    <div class="container">
        <h2>ğŸ” è®¤è¯æµ‹è¯•</h2>
        
        <div class="form-group">
            <label>é€‰æ‹©æµ‹è¯•æ¨¡å¼:</label>
            <select id="testMode" onchange="switchMode()">
                <option value="api">çœŸå®APIæµ‹è¯•</option>
                <option value="mock">æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼</option>
            </select>
        </div>
        
        <div id="apiTestArea">
            <div class="form-group">
                <label>é‚®ç®±:</label>
                <input type="email" id="email" value="teacher@example.com">
            </div>
            <div class="form-group">
                <label>å¯†ç :</label>
                <input type="password" id="password" value="123456">
            </div>
            <button onclick="login()">ğŸ”‘ ç™»å½•</button>
            <button onclick="testLibraryAPI()" class="success">ğŸ“š æµ‹è¯•æˆæœåº“API</button>
            <button onclick="clearTokens()" class="danger">ğŸ—‘ï¸ æ¸…é™¤Token</button>
        </div>
        
        <div id="mockTestArea" style="display:none;">
            <button onclick="loadMockData()" class="warning">ğŸ“‹ åŠ è½½æ¨¡æ‹Ÿæ•°æ®</button>
            <p class="info">æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼ï¼šæ— éœ€ç™»å½•ï¼Œç›´æ¥åŠ è½½ç¤ºä¾‹å­¦ç”Ÿæˆæœæ•°æ®</p>
        </div>
        
        <div id="authResult" class="result"></div>
    </div>

    <!-- æˆæœæ•°æ®å±•ç¤º -->
    <div class="container">
        <h2>ğŸ“š å­¦ç”Ÿæˆæœæ•°æ®</h2>
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <button onclick="exportData()" class="success">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
        <div id="dataResult"></div>
        
        <table class="projects-table" id="projectsTable" style="display:none;">
            <thead>
                <tr>
                    <th>æˆæœåç§°</th>
                    <th>åˆ†æ•°</th>
                    <th>ç±»å‹</th>
                    <th>å­¦ç”Ÿå§“å</th>
                    <th>æŒ‡å¯¼è€å¸ˆ</th>
                    <th>ç­çº§</th>
                    <th>æäº¤æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="projectsTableBody">
            </tbody>
        </table>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentToken = null;
        let currentProjects = [];

        // åˆ‡æ¢æµ‹è¯•æ¨¡å¼
        function switchMode() {
            const mode = document.getElementById('testMode').value;
            const apiArea = document.getElementById('apiTestArea');
            const mockArea = document.getElementById('mockTestArea');
            
            if (mode === 'mock') {
                apiArea.style.display = 'none';
                mockArea.style.display = 'block';
            } else {
                apiArea.style.display = 'block';
                mockArea.style.display = 'none';
            }
            
            // æ¸…é™¤ç»“æœ
            document.getElementById('authResult').innerHTML = '';
            document.getElementById('dataResult').innerHTML = '';
            currentProjects = [];
            updateStats();
        }

        // ç™»å½•
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('authResult');

            try {
                resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨ç™»å½•...';
                
                const response = await fetch(`${API_BASE}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    currentToken = data.data.token;
                    localStorage.setItem('teacherToken', currentToken);
                    
                    resultDiv.innerHTML = `âœ… ç™»å½•æˆåŠŸ!
ğŸ“‹ ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(data.data.user, null, 2)}
ğŸ“‹ Token: ${currentToken.substring(0, 50)}...`;
                    resultDiv.className = 'result success';
                    
                    // è‡ªåŠ¨æµ‹è¯•API
                    setTimeout(testLibraryAPI, 1000);
                } else {
                    resultDiv.innerHTML = `âŒ ç™»å½•å¤±è´¥: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // æµ‹è¯•æˆæœåº“API
        async function testLibraryAPI() {
            const resultDiv = document.getElementById('authResult');
            const token = currentToken || localStorage.getItem('teacherToken');
            
            if (!token) {
                resultDiv.innerHTML = 'âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆtokenï¼Œè¯·å…ˆç™»å½•';
                resultDiv.className = 'result error';
                return;
            }

            try {
                resultDiv.innerHTML += '\n\nğŸ”„ æµ‹è¯•æˆæœåº“API...';
                
                const response = await fetch(`${API_BASE}/teacher/student-achievements?page=1&pageSize=100`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    currentProjects = Array.isArray(data.data) ? data.data : data.data.items || [];
                    resultDiv.innerHTML += `\nâœ… APIè°ƒç”¨æˆåŠŸ! è·å–åˆ° ${currentProjects.length} ä¸ªæˆæœ`;
                    resultDiv.className = 'result success';
                    
                    displayProjects(currentProjects);
                } else {
                    resultDiv.innerHTML += `\nâŒ APIè°ƒç”¨å¤±è´¥ (${response.status}): ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result warning';
                    
                    // 400é”™è¯¯æ—¶å»ºè®®ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    if (response.status === 400) {
                        resultDiv.innerHTML += '\nğŸ’¡ å»ºè®®ï¼šåˆ‡æ¢åˆ°"æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼"è¿›è¡Œæµ‹è¯•';
                    }
                }
            } catch (error) {
                resultDiv.innerHTML += `\nâŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // åŠ è½½æ¨¡æ‹Ÿæ•°æ®
        function loadMockData() {
            const resultDiv = document.getElementById('authResult');
            
            currentProjects = [
                {
                    id: '1',
                    title: 'æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿå¼€å‘',
                    project_type: 'é¡¹ç›®',
                    student_name: 'å¼ ä¸‰',
                    student_id: 'S001',
                    class_name: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯1ç­',
                    grade_name: '2021çº§',
                    instructor_name: 'ææ•™æˆ',
                    score: 95,
                    created_at: '2024-01-15T10:30:00Z',
                    cover_image: null,
                    status: 2
                },
                {
                    id: '2',
                    title: 'åŸºäºæ·±åº¦å­¦ä¹ çš„å›¾åƒè¯†åˆ«ç ”ç©¶',
                    project_type: 'è®ºæ–‡',
                    student_name: 'æå››',
                    student_id: 'S002',
                    class_name: 'è½¯ä»¶å·¥ç¨‹2ç­',
                    grade_name: '2021çº§',
                    instructor_name: 'ç‹æ•™æˆ',
                    score: 88,
                    created_at: '2024-01-18T14:20:00Z',
                    cover_image: null,
                    status: 2
                },
                {
                    id: '3',
                    title: 'ç§»åŠ¨åº”ç”¨UIè®¾è®¡',
                    project_type: 'è®¾è®¡',
                    student_name: 'ç‹äº”',
                    student_id: 'S003',
                    class_name: 'æ•°å­—åª’ä½“æŠ€æœ¯1ç­',
                    grade_name: '2021çº§',
                    instructor_name: 'é™ˆæ•™æˆ',
                    score: null,
                    created_at: '2024-01-20T16:45:00Z',
                    cover_image: null,
                    status: 1
                },
                {
                    id: '4',
                    title: 'ç”µå­å•†åŠ¡å¹³å°å¼€å‘',
                    project_type: 'é¡¹ç›®',
                    student_name: 'èµµå…­',
                    student_id: 'S004',
                    class_name: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2ç­',
                    grade_name: '2022çº§',
                    instructor_name: 'å¼ æ•™æˆ',
                    score: 92,
                    created_at: '2024-01-22T09:15:00Z',
                    cover_image: null,
                    status: 2
                },
                {
                    id: '5',
                    title: 'æœºå™¨å­¦ä¹ æ¨¡å‹ä¼˜åŒ–ç ”ç©¶',
                    project_type: 'è®ºæ–‡',
                    student_name: 'å­™ä¸ƒ',
                    student_id: 'S005',
                    class_name: 'äººå·¥æ™ºèƒ½1ç­',
                    grade_name: '2022çº§',
                    instructor_name: 'åˆ˜æ•™æˆ',
                    score: 85,
                    created_at: '2024-01-25T11:30:00Z',
                    cover_image: null,
                    status: 2
                }
            ];
            
            resultDiv.innerHTML = `âœ… æ¨¡æ‹Ÿæ•°æ®åŠ è½½æˆåŠŸ! å…± ${currentProjects.length} ä¸ªå­¦ç”Ÿæˆæœ`;
            resultDiv.className = 'result success';
            
            displayProjects(currentProjects);
        }

        // æ˜¾ç¤ºæˆæœæ•°æ®
        function displayProjects(projects) {
            const dataDiv = document.getElementById('dataResult');
            const table = document.getElementById('projectsTable');
            const tbody = document.getElementById('projectsTableBody');
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            // æ¸…ç©ºè¡¨æ ¼
            tbody.innerHTML = '';
            
            if (projects.length === 0) {
                dataDiv.innerHTML = 'ğŸ“‹ æš‚æ— å­¦ç”Ÿæˆæœæ•°æ®';
                table.style.display = 'none';
                return;
            }
            
            // å¡«å……è¡¨æ ¼
            projects.forEach(project => {
                const row = tbody.insertRow();
                
                // æˆæœåç§°
                row.insertCell(0).textContent = project.title || 'æœªå‘½å';
                
                // åˆ†æ•°
                const scoreCell = row.insertCell(1);
                if (project.score) {
                    const scoreClass = getScoreClass(project.score);
                    scoreCell.innerHTML = `<span class="${scoreClass}">${project.score}åˆ†</span>`;
                } else {
                    scoreCell.textContent = 'æœªè¯„åˆ†';
                }
                
                // ç±»å‹
                row.insertCell(2).textContent = project.project_type || 'æœªåˆ†ç±»';
                
                // å­¦ç”Ÿå§“å
                row.insertCell(3).textContent = project.student_name || 'æœªçŸ¥';
                
                // æŒ‡å¯¼è€å¸ˆ
                row.insertCell(4).textContent = project.instructor_name || 'æœªæŒ‡å®š';
                
                // ç­çº§
                row.insertCell(5).textContent = project.class_name || 'æœªåˆ†ç±»';
                
                // æäº¤æ—¶é—´
                const date = new Date(project.created_at);
                row.insertCell(6).textContent = date.toLocaleString();
            });
            
            table.style.display = 'table';
            dataDiv.innerHTML = `ğŸ“‹ æˆåŠŸæ˜¾ç¤º ${projects.length} ä¸ªå­¦ç”Ÿæˆæœ`;
        }

        // è·å–åˆ†æ•°æ ·å¼ç±»
        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 80) return 'score-good';
            if (score >= 70) return 'score-average';
            if (score >= 60) return 'score-pass';
            return 'score-fail';
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('totalProjects').textContent = currentProjects.length;
            document.getElementById('excellentProjects').textContent = currentProjects.filter(p => p.score >= 90).length;
            
            const avgScore = currentProjects.length > 0 
                ? (currentProjects.reduce((sum, p) => sum + (p.score || 0), 0) / currentProjects.length).toFixed(1)
                : '0.0';
            document.getElementById('avgScore').textContent = avgScore;
            
            const studentCount = new Set(currentProjects.map(p => p.student_id)).size;
            document.getElementById('studentCount').textContent = studentCount;
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            const mode = document.getElementById('testMode').value;
            if (mode === 'mock') {
                loadMockData();
            } else {
                testLibraryAPI();
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (currentProjects.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // åˆ›å»ºCSVå†…å®¹
            let csv = 'æˆæœåç§°,åˆ†æ•°,ç±»å‹,å­¦ç”Ÿå§“å,å­¦å·,æŒ‡å¯¼è€å¸ˆ,ç­çº§,æäº¤æ—¶é—´\n';
            currentProjects.forEach(project => {
                csv += `"${project.title}",${project.score || 'æœªè¯„åˆ†'},"${project.project_type}","${project.student_name}","${project.student_id}","${project.instructor_name}","${project.class_name}","${new Date(project.created_at).toLocaleString()}"\n`;
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å­¦ç”Ÿæˆæœæ•°æ®_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ¸…é™¤Token
        function clearTokens() {
            localStorage.removeItem('teacherToken');
            sessionStorage.removeItem('teacherToken');
            localStorage.removeItem('token');
            currentToken = null;
            currentProjects = [];
            
            document.getElementById('authResult').innerHTML = 'âœ… Tokenå·²æ¸…é™¤';
            document.getElementById('authResult').className = 'result success';
            document.getElementById('projectsTable').style.display = 'none';
            document.getElementById('dataResult').innerHTML = '';
            updateStats();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            updateStats();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„token
            const savedToken = localStorage.getItem('teacherToken');
            if (savedToken) {
                document.getElementById('authResult').innerHTML = `âœ… æ‰¾åˆ°ä¿å­˜çš„Token: ${savedToken.substring(0, 50)}...`;
                currentToken = savedToken;
            }
        };
    </script>
</body>
</html>