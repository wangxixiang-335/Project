<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆæµ‹è¯• - å­¦ç”Ÿå’Œæ•™å¸ˆæˆæœå‘å¸ƒ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #117a8b;
        }
        .preview-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            min-height: 100px;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .feature-list li:before {
            content: "âœ… ";
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆæµ‹è¯•</h1>
        <p>æµ‹è¯•å­¦ç”Ÿå’Œæ•™å¸ˆæˆæœå‘å¸ƒé¡µé¢çš„å¯Œæ–‡æœ¬å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½</p>

        <div class="test-section">
            <h3>ğŸ“‹ åŠŸèƒ½ç‰¹æ€§</h3>
            <ul class="feature-list">
                <li>ç±»ä¼¼å­¦ä¹ é€šçš„å›¾æ–‡æ··åˆç¼–è¾‘ä½“éªŒ</li>
                <li>æ”¯æŒæ–‡å­— + å›¾ç‰‡ + æ–‡å­—çš„æ··åˆå†…å®¹</li>
                <li>å›¾ç‰‡ä¸Šä¼ åˆ°Supabaseå­˜å‚¨æ¡¶</li>
                <li>æ•°æ®åº“ä¸­åªå­˜å‚¨å›¾ç‰‡URLï¼Œå‡å°‘å­˜å‚¨é‡</li>
                <li>æ”¯æŒæ‹–æ‹½ä¸Šä¼ å’Œç²˜è´´ä¸Šä¼ </li>
                <li>å›¾ç‰‡æ•°é‡é™åˆ¶ï¼ˆæœ€å¤š10å¼ ï¼‰</li>
                <li>å®æ—¶å†…å®¹åŒæ­¥</li>
                <li>åå¤‡æ–‡æœ¬æ¡†æ–¹æ¡ˆ</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
            <div id="systemStatus">
                <div class="status info">æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æµ‹è¯•</h3>
            <div id="editorStatus">
                <div class="status info">æ­£åœ¨åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨...</div>
            </div>
            <div id="richEditorContainer" style="margin-top: 20px;"></div>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="testImageUpload()">ğŸ“· æµ‹è¯•å›¾ç‰‡ä¸Šä¼ </button>
                <button class="btn btn-success" onclick="getContent()">ğŸ“ è·å–å†…å®¹</button>
                <button class="btn btn-info" onclick="insertTestContent()">ğŸ¯ æ’å…¥æµ‹è¯•å†…å®¹</button>
                <button class="btn btn-primary" onclick="clearEditor()">ğŸ§¹ æ¸…ç©ºç¼–è¾‘å™¨</button>
            </div>
            <div class="preview-area" id="contentPreview">
                <strong>å†…å®¹é¢„è§ˆï¼š</strong>
                <div id="previewContent">æš‚æ— å†…å®¹</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="testResults">
                <div class="status info">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debugInfo" class="code-block">
// è°ƒè¯•ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
            </div>
        </div>
    </div>

    <script>
        let richEditor = null;
        const API_BASE = '/api';

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            debugInfo.textContent += logEntry;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            try {
                log('å¼€å§‹æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
                
                // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
                const healthResponse = await fetch(`${API_BASE}/health`);
                const healthData = await healthResponse.json();
                
                if (healthData.success) {
                    log('âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸');
                    showStatus('systemStatus', 'âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸', 'success');
                } else {
                    log('âŒ æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸');
                    showStatus('systemStatus', 'âŒ æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸', 'error');
                }
                
                // æ£€æŸ¥å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è„šæœ¬
                const scriptResponse = await fetch('/rich-editor.js');
                if (scriptResponse.ok) {
                    log('âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è„šæœ¬å¯è®¿é—®');
                } else {
                    log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è„šæœ¬æ— æ³•è®¿é—®');
                }
                
            } catch (error) {
                log(`âŒ ç³»ç»Ÿæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                showStatus('systemStatus', `âŒ ç³»ç»Ÿæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        async function loadRichEditor() {
            try {
                log('å¼€å§‹åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨...');
                showStatus('editorStatus', 'æ­£åœ¨åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨...', 'info');
                
                // æ£€æŸ¥RichTextEditoræ˜¯å¦å¯ç”¨
                if (typeof window.RichTextEditor === 'undefined') {
                    log('RichTextEditoræœªå®šä¹‰ï¼Œå°è¯•åŠ¨æ€åŠ è½½...');
                    
                    // åŠ¨æ€åŠ è½½è„šæœ¬
                    const script = document.createElement('script');
                    script.src = '/rich-editor.js';
                    script.async = true;
                    
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    
                    log('âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è„šæœ¬åŠ è½½æˆåŠŸ');
                }
                
                // åˆå§‹åŒ–ç¼–è¾‘å™¨
                if (typeof window.RichTextEditor !== 'undefined') {
                    richEditor = new window.RichTextEditor('richEditorContainer', {
                        placeholder: 'è¯·è¾“å…¥å†…å®¹ï¼Œæ”¯æŒæ–‡å­—å’Œå›¾ç‰‡æ··åˆç¼–è¾‘ï¼Œç±»ä¼¼å­¦ä¹ é€šçš„ä½œä¸šæäº¤ä½“éªŒ...',
                        maxImages: 10,
                        uploadEndpoint: `${API_BASE}/upload/image`,
                        onImageUpload: (data) => {
                            log(`âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ${data.url}`);
                            showStatus('editorStatus', 'âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                        },
                        onContentChange: (content) => {
                            log('å†…å®¹å·²æ›´æ–°');
                            updatePreview(content);
                        }
                    });
                    
                    log('âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆå§‹åŒ–æˆåŠŸ');
                    showStatus('editorStatus', 'âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å·²å°±ç»ª', 'success');
                } else {
                    throw new Error('å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠ è½½å¤±è´¥');
                }
                
            } catch (error) {
                log(`âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                showStatus('editorStatus', `âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
        async function testImageUpload() {
            if (!richEditor) {
                log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                showStatus('testResults', 'âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                log('å¼€å§‹æµ‹è¯•å›¾ç‰‡ä¸Šä¼ ...');
                showStatus('testResults', 'æ­£åœ¨æµ‹è¯•å›¾ç‰‡ä¸Šä¼ ...', 'info');
                
                // åˆ›å»ºä¸€ä¸ªæµ‹è¯•å›¾ç‰‡ï¼ˆä½¿ç”¨åœ¨çº¿å ä½å›¾ç‰‡ï¼‰
                const testImageUrl = 'https://via.placeholder.com/600x400/FF6B6B/FFFFFF?text=æµ‹è¯•å›¾ç‰‡';
                
                // ç›´æ¥æ’å…¥æµ‹è¯•å›¾ç‰‡
                richEditor.insertImageToEditor(testImageUrl, 'æµ‹è¯•å›¾ç‰‡');
                
                log('âœ… æµ‹è¯•å›¾ç‰‡å·²æ’å…¥åˆ°ç¼–è¾‘å™¨');
                showStatus('testResults', 'âœ… å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ­£å¸¸', 'success');
                
            } catch (error) {
                log(`âŒ å›¾ç‰‡ä¸Šä¼ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showStatus('testResults', `âŒ å›¾ç‰‡ä¸Šä¼ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–ç¼–è¾‘å™¨å†…å®¹
        function getContent() {
            if (!richEditor) {
                log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const content = richEditor.getContent();
            const textContent = richEditor.getTextContent();
            const images = richEditor.getImages();
            
            log(`è·å–å†…å®¹æˆåŠŸ: ${textContent.length} å­—ç¬¦, ${images.length} å¼ å›¾ç‰‡`);
            
            const result = {
                html: content,
                text: textContent,
                images: images,
                imageCount: images.length
            };
            
            showStatus('testResults', `âœ… å†…å®¹è·å–æˆåŠŸï¼å­—ç¬¦æ•°: ${textContent.length}, å›¾ç‰‡æ•°: ${images.length}`, 'success');
            
            // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML += `
                <div class="code-block">
HTMLå†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦
çº¯æ–‡æœ¬é•¿åº¦: ${textContent.length} å­—ç¬¦
å›¾ç‰‡æ•°é‡: ${images.length} å¼ 
å›¾ç‰‡åˆ—è¡¨: ${images.map(img => img.url || img.alt).join(', ') || 'æ— '}
                </div>
            `;
        }

        // æ’å…¥æµ‹è¯•å†…å®¹
        function insertTestContent() {
            if (!richEditor) {
                log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const testContent = `
                <h3>ğŸ¯ æµ‹è¯•é¡¹ç›®æ ‡é¢˜</h3>
                <p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆ›å»ºçš„æµ‹è¯•å†…å®¹ã€‚æ”¯æŒ<strong>åŠ ç²—</strong>ã€<em>æ–œä½“</em>ã€<u>ä¸‹åˆ’çº¿</u>ç­‰æ ¼å¼ã€‚</p>
                <h4>ä¸»è¦åŠŸèƒ½</h4>
                <ul>
                    <li>æ”¯æŒæ–‡å­—å’Œå›¾ç‰‡æ··åˆç¼–è¾‘</li>
                    <li>ç±»ä¼¼å­¦ä¹ é€šçš„ä½¿ç”¨ä½“éªŒ</li>
                    <li>å›¾ç‰‡ä¸Šä¼ åˆ°Supabaseå­˜å‚¨æ¡¶</li>
                    <li>æ•°æ®åº“ä¸­åªå­˜å‚¨å›¾ç‰‡URL</li>
                </ul>
                <p>å¯ä»¥åœ¨å…‰æ ‡ä½ç½®æ’å…¥å›¾ç‰‡ï¼Œæ”¯æŒæ‹–æ‹½å’Œç²˜è´´ä¸Šä¼ ã€‚</p>
            `;
            
            richEditor.setContent(testContent);
            log('âœ… æµ‹è¯•å†…å®¹å·²æ’å…¥');
            showStatus('testResults', 'âœ… æµ‹è¯•å†…å®¹å·²æ’å…¥', 'success');
        }

        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearEditor() {
            if (!richEditor) {
                log('âŒ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            richEditor.clear();
            log('âœ… ç¼–è¾‘å™¨å·²æ¸…ç©º');
            showStatus('testResults', 'âœ… ç¼–è¾‘å™¨å·²æ¸…ç©º', 'success');
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview(content) {
            const previewContent = document.getElementById('previewContent');
            if (previewContent) {
                previewContent.innerHTML = content || '<em>æš‚æ— å†…å®¹</em>';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            checkSystemStatus();
            
            // å»¶è¿ŸåŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            setTimeout(() => {
                loadRichEditor();
            }, 1000);
        });
    </script>
</body>
</html>