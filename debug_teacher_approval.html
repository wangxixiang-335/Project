<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试教师审批功能</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { margin: 5px; padding: 8px 12px; cursor: pointer; }
        #console { background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>教师审批功能调试</h1>
    
    <div class="debug-section">
        <h3>测试环境检查</h3>
        <button onclick="checkEnvironment()">检查环境</button>
        <button onclick="testAuth()">测试认证</button>
        <button onclick="testApiConnection()">测试API连接</button>
    </div>
    
    <div class="debug-section">
        <h3>审批功能测试</h3>
        <button onclick="testViewProject()">测试查看项目</button>
        <button onclick="testApproveProject()">测试通过项目</button>
        <button onclick="testRejectProject()">测试驳回项目</button>
    </div>
    
    <div class="debug-section">
        <h3>控制台输出</h3>
        <div id="console"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            console.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
        }

        function checkEnvironment() {
            log('=== 环境检查 ===');
            
            // 检查token
            const token = localStorage.getItem('teacherToken') || sessionStorage.getItem('teacherToken');
            log(`Token存在: ${token ? '是' : '否'}`);
            
            // 检查teacherSystem
            if (typeof window.teacherSystem !== 'undefined') {
                log('teacherSystem对象存在: 是', 'success');
                log(`当前页面: ${teacherSystem.currentPage}`);
                log(`当前用户: ${teacherSystem.user ? teacherSystem.user.username : '未登录'}`);
            } else {
                log('teacherSystem对象存在: 否', 'error');
            }
            
            // 检查函数
            log(`reviewProject函数存在: ${typeof window.reviewProject === 'function' ? '是' : '否'}`);
            log(`confirmApproval函数存在: ${typeof window.confirmApproval === 'function' ? '是' : '否'}`);
            
            // 检查DOM元素
            const modal = document.getElementById('approvalModal');
            log(`审批模态框存在: ${modal ? '是' : '否'}`);
            
            const approvalList = document.getElementById('approvalList');
            log(`审批列表容器存在: ${approvalList ? '是' : '否'}`);
        }

        async function testAuth() {
            log('=== 认证测试 ===');
            
            const token = localStorage.getItem('teacherToken') || sessionStorage.getItem('teacherToken');
            if (!token) {
                log('没有token，请先登录', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`认证成功: ${result.data.username} (${result.data.role})`, 'success');
                } else {
                    log(`认证失败: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`认证请求失败: ${error.message}`, 'error');
            }
        }

        async function testApiConnection() {
            log('=== API连接测试 ===');
            
            try {
                const response = await fetch('http://localhost:3000/api/review/pending', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('teacherToken') || sessionStorage.getItem('teacherToken') || ''}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`待审批项目获取成功: ${result.data.length} 个项目`, 'success');
                } else {
                    log(`待审批项目获取失败: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`API连接失败: ${error.message}`, 'error');
            }
        }

        function testViewProject() {
            log('=== 查看项目测试 ===');
            
            if (typeof window.reviewProject === 'function') {
                try {
                    window.reviewProject('test-id-123');
                    log('reviewProject函数调用成功', 'success');
                    
                    // 检查模态框是否显示
                    setTimeout(() => {
                        const modal = document.getElementById('approvalModal');
                        if (modal && modal.style.display === 'block') {
                            log('模态框显示成功', 'success');
                        } else {
                            log('模态框未显示', 'error');
                        }
                    }, 100);
                    
                } catch (error) {
                    log(`reviewProject函数调用失败: ${error.message}`, 'error');
                }
            } else {
                log('reviewProject函数不存在', 'error');
            }
        }

        function testApproveProject() {
            log('=== 通过项目测试 ===');
            testApprovalAction('approve');
        }

        function testRejectProject() {
            log('=== 驳回项目测试 ===');
            testApprovalAction('reject');
        }

        async function testApprovalAction(action) {
            const token = localStorage.getItem('teacherToken') || sessionStorage.getItem('teacherToken');
            if (!token) {
                log('没有token，请先登录', 'error');
                return;
            }
            
            const projectId = 'test-project-id'; // 测试项目ID
            const rejectReason = action === 'reject' ? '测试驳回原因' : '';
            
            try {
                const response = await fetch(`http://localhost:3000/api/review/${projectId}/audit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        audit_result: action,
                        reject_reason: rejectReason
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`${action === 'approve' ? '通过' : '驳回'}操作成功`, 'success');
                } else {
                    log(`${action === 'approve' ? '通过' : '驳回'}操作失败: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`审批请求失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后自动检查
        window.addEventListener('DOMContentLoaded', () => {
            log('调试页面加载完成');
            setTimeout(checkEnvironment, 1000); // 等待teacher.js加载
        });
    </script>
</body>
</html>