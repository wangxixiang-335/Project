<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆæˆæœå‘å¸ƒæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: inline-block; width: 120px; font-weight: bold; }
        input, textarea, select { width: 300px; padding: 5px; }
        textarea { height: 100px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .preview { margin-top: 10px; max-width: 200px; }
        .preview img { max-width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ•™å¸ˆæˆæœå‘å¸ƒåŠŸèƒ½æµ‹è¯•</h1>
        
        <div id="status"></div>
        
        <h2>1. æ•™å¸ˆç™»å½•</h2>
        <div class="form-group">
            <label>é‚®ç®±:</label>
            <input type="email" id="email" value="teacher@example.com">
        </div>
        <div class="form-group">
            <label>å¯†ç :</label>
            <input type="password" id="password" value="password123">
        </div>
        <button onclick="login()">ç™»å½•</button>
        
        <h2>2. æˆæœå‘å¸ƒ</h2>
        <div class="form-group">
            <label>æ ‡é¢˜:</label>
            <input type="text" id="title" value="æµ‹è¯•æˆæœæ ‡é¢˜">
        </div>
        <div class="form-group">
            <label>å°é¢å›¾URL:</label>
            <input type="text" id="coverImage" value="https://picsum.photos/400/300?random=1" 
                   onchange="previewCoverImage()">
            <div id="coverPreview" class="preview"></div>
        </div>
        <div class="form-group">
            <label>å†…å®¹:</label>
            <textarea id="content"><p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æˆæœçš„å†…å®¹ã€‚</p><p>åŒ…å«å°é¢å›¾ä¸Šä¼ åŠŸèƒ½æµ‹è¯•ã€‚</p></textarea>
        </div>
        <div class="form-group">
            <label>æˆæœç±»å‹:</label>
            <select id="category">
                <option value="f47ac10b-58cc-4372-a567-0e02b2c3d479">ç§‘æŠ€åˆ›æ–°</option>
                <option value="a1b2c3d4-e5f6-7890-abcd-ef1234567890">è‰ºæœ¯åˆ›ä½œ</option>
            </select>
        </div>
        <button onclick="publish()" id="publishBtn" disabled>å‘å¸ƒæˆæœ</button>
        
        <h2>3. æµ‹è¯•ç»“æœ</h2>
        <div id="result"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let authToken = null;
        let userId = null;

        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            status.appendChild(div);
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log('æ­£åœ¨ç™»å½•...');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.data.token;
                    userId = data.data.user.id;
                    log('âœ… ç™»å½•æˆåŠŸï¼ç”¨æˆ·ID: ' + userId, 'success');
                    document.getElementById('publishBtn').disabled = false;
                } else {
                    log('âŒ ç™»å½•å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                log('âŒ ç™»å½•é”™è¯¯: ' + error.message, 'error');
            }
        }

        function previewCoverImage() {
            const coverUrl = document.getElementById('coverImage').value;
            const preview = document.getElementById('coverPreview');
            
            if (coverUrl) {
                preview.innerHTML = `<img src="${coverUrl}" alt="å°é¢é¢„è§ˆ" onerror="this.style.display='none'">`;
            } else {
                preview.innerHTML = '';
            }
        }

        async function publish() {
            if (!authToken) {
                log('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const title = document.getElementById('title').value;
            const coverImage = document.getElementById('coverImage').value;
            const content = document.getElementById('content').value;
            const category = document.getElementById('category').value;
            
            log('æ­£åœ¨å‘å¸ƒæˆæœ...');
            log('å‘å¸ƒæ•°æ®: ' + JSON.stringify({
                title,
                video_url: coverImage, // å°é¢å›¾é€šè¿‡video_urlå­—æ®µä¼ é€’
                content_html: content,
                category
            }, null, 2));
            
            try {
                const response = await fetch(`${API_BASE}/projects/teacher-publish`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        title,
                        video_url: coverImage, // å°é¢å›¾é€šè¿‡video_urlå­—æ®µä¼ é€’
                        content_html: content,
                        category
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('âœ… æˆæœå‘å¸ƒæˆåŠŸï¼', 'success');
                    log('ğŸ“‹ æˆæœID: ' + data.data.project_id, 'success');
                    log('ğŸ“Š çŠ¶æ€: ' + data.data.status, 'success');
                    log('âœ… å°é¢å›¾å·²ä¿å­˜: ' + coverImage, 'success');
                    
                    // éªŒè¯æ•°æ®åº“ä¸­çš„å°é¢å›¾
                    verifyCoverImage(data.data.project_id, coverImage);
                } else {
                    log('âŒ å‘å¸ƒå¤±è´¥: ' + data.error, 'error');
                    if (data.details) {
                        log('é”™è¯¯è¯¦æƒ…: ' + JSON.stringify(data.details), 'error');
                    }
                }
            } catch (error) {
                log('âŒ å‘å¸ƒé”™è¯¯: ' + error.message, 'error');
            }
        }

        async function verifyCoverImage(projectId, expectedCoverUrl) {
            log('æ­£åœ¨éªŒè¯æ•°æ®åº“ä¸­çš„å°é¢å›¾...');
            
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    const actualCoverUrl = data.data.cover_url;
                    if (actualCoverUrl === expectedCoverUrl) {
                        log('âœ… å°é¢å›¾URLå·²æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“ï¼', 'success');
                        log('ğŸ“Š æ•°æ®åº“ä¸­çš„å°é¢å›¾: ' + actualCoverUrl, 'success');
                    } else {
                        log('âŒ å°é¢å›¾URLä¸åŒ¹é…', 'error');
                        log('æœŸæœ›: ' + expectedCoverUrl, 'error');
                        log('å®é™…: ' + actualCoverUrl, 'error');
                    }
                } else {
                    log('âŒ æ— æ³•éªŒè¯å°é¢å›¾: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                log('âŒ éªŒè¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶é¢„è§ˆé»˜è®¤å°é¢å›¾
        window.onload = function() {
            previewCoverImage();
        };
    </script>
</body>
</html>